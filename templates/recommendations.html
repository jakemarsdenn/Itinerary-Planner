{% extends "base.html" %}

{% block title %}Recommendations{% endblock %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css', version='1.0') }}">
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places,directions&callback=initMap" async defer></script>
<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0,0,0);
        background-color: rgba(0,0,0,0.4);
        padding-top: 60px;
    }
    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
    }
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    #map {
        height: 500px;
        width: 100%;
    }
</style>

{% block content %}
    <body>
        <h1 style="margin-top:100px;">{{ task.title() }} Recommendations</h1>
        <ul class="recommendations-list">
            {% for recommendation in recommendations %}
            <li class="recommendation-item" data-lat="{{ recommendation.coordinates.latitude }}" data-lon="{{ recommendation.coordinates.longitude }}">
                <img src="{{ recommendation.image_url }}" alt="{{ recommendation.name }}" class="recommendation-image">
                <div class="recommendation-details">
                    <h2>{{ recommendation.name }}</h2>
                    <p class="rating">{{ recommendation.rating }} stars</p>
                    <p class="eta">ETA: Calculating...</p>
                    <p class="distance">Distance: Calculating...</p>
                    <button class="get-directions" data-lat="{{ recommendation.coordinates.latitude }}" data-lon="{{ recommendation.coordinates.longitude }}">Get Directions</button>
                </div>
            </li>
            {% endfor %}
        </ul>

        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <div id="map"></div>
            </div>
        </div>

        <script>
            let map, directionsService, directionsRenderer;

            function initMap() {
                console.log("Initializing map...");
                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer();

                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 7,
                    center: { lat: 41.85, lng: -87.65 }
                });

                directionsRenderer.setMap(map);

                document.querySelectorAll('.get-directions').forEach(button => {
                    button.addEventListener('click', () => {
                        const lat = button.getAttribute('data-lat');
                        const lon = button.getAttribute('data-lon');
                        openModal();
                        calculateAndDisplayRoute(lat, lon);
                    });
                });

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(position => {
                        const userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        document.querySelectorAll('.recommendation-item').forEach(item => {
                            const lat = item.getAttribute('data-lat');
                            const lon = item.getAttribute('data-lon');
                            const etaElem = item.querySelector('.eta');
                            const distanceElem = item.querySelector('.distance');

                            calculateDistanceAndTime(userLocation, { lat: parseFloat(lat), lng: parseFloat(lon) })
                                .then(({ duration, distance }) => {
                                    etaElem.textContent = `ETA: ${duration}`;
                                    distanceElem.textContent = `Distance: ${distance.toFixed(1)} miles`;
                                })
                                .catch(error => {
                                    console.error('Error calculating distance and time:', error);
                                    etaElem.textContent = 'ETA: Error';
                                    distanceElem.textContent = 'Distance: Error';
                                });
                        });
                    }, error => {
                        console.error('Geolocation error:', error);
                        handleLocationError(true);
                    });
                } else {
                    console.error('Browser does not support geolocation');
                    handleLocationError(false);
                }
            }

            function openModal() {
                const modal = document.getElementById('myModal');
                const span = document.getElementsByClassName('close')[0];

                modal.style.display = 'block';

                span.onclick = function() {
                    modal.style.display = 'none';
                }

                window.onclick = function(event) {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                }
            }

            function calculateAndDisplayRoute(lat, lon) {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            console.log("Geolocation successful");
                            const userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            directionsService.route(
                                {
                                    origin: userLocation,
                                    destination: { lat: parseFloat(lat), lng: parseFloat(lon) },
                                    travelMode: google.maps.TravelMode.DRIVING
                                },
                                (response, status) => {
                                    if (status === 'OK') {
                                        directionsRenderer.setDirections(response);
                                    } else {
                                        console.error('Directions request failed due to ' + status);
                                        alert('Directions request failed due to ' + status);
                                    }
                                }
                            );
                        },
                        error => {
                            console.error('Geolocation error:', error);
                            handleLocationError(true);
                        }
                    );
                } else {
                    console.error('Browser does not support geolocation');
                    handleLocationError(false);
                }
            }

            function calculateDistanceAndTime(origin, destination) {
                return new Promise((resolve, reject) => {
                    directionsService.route(
                        {
                            origin,
                            destination,
                            travelMode: google.maps.TravelMode.DRIVING
                        },
                        (response, status) => {
                            if (status === 'OK') {
                                const route = response.routes[0].legs[0];
                                const duration = route.duration.text;
                                const distance_km = route.distance.value / 1000;
                                const distance_miles = distance_km * 0.621371;
                                resolve({ duration, distance: distance_miles });
                            } else {
                                reject(new Error(`Directions request failed due to ${status}`));
                            }
                        }
                    );
                });
            }

            function handleLocationError(browserHasGeolocation) {
                alert(browserHasGeolocation ? 'Error: The Geolocation service failed.' : 'Error: Your browser doesn\'t support geolocation.');
            }
        </script>
    </body>
{% endblock %}
